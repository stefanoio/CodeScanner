class CodeScanner{_polyfillScrs=["https://cdn.jsdelivr.net/npm/@undecaf/zbar-wasm@0.10.1/dist/index.js","https://cdn.jsdelivr.net/npm/@undecaf/barcode-detector-polyfill@0.9.20/dist/index.js"];_ready=!1;_running=!1;_error=!1;_readyCallbacks=[];_errorCallbacks=[];constructor(t,e=!1,r=10){if(!(t instanceof HTMLVideoElement))throw this._setIsError(),Error("The first argument must be a video element");if(!1!==e&&!Array.isArray(e))throw this._setIsError(),Error("The second argument must be an array of formats or false");if("number"!=typeof r||r<=0)throw this._setIsError(),Error("The third argument must be a positive number");this._initBarcodeDetector().then(({barcodeDetector:a,supportedFormats:s})=>{this._videoElement=t,this._formats=e,this._frameRate=r,this._barcodeDetector=new a,this._supportedFormats=s,!1===e?this._formats=this._supportedFormats:(e.forEach(t=>{if(!this._supportedFormats.includes(t))throw this._setIsError(),Error(`Format ${t} is not supported. Supported formats are: ${this._supportedFormats.join(", ")}`)}),this._formats=e),this._setIsReady()}).catch(()=>this._setIsError())}_setIsReady(){this._ready=!0,this._error=!1,this._readyCallbacks.forEach(t=>t()),this._readyCallbacks=[],this._errorCallbacks=[]}_setIsError(){this._error=!0,this._ready=!1,this._errorCallbacks.forEach(t=>t()),this._readyCallbacks=[],this._errorCallbacks=[]}async _initBarcodeDetector(){let t=async t=>({barcodeDetector:t,supportedFormats:await t.getSupportedFormats()});try{return await t(window.BarcodeDetector)}catch{}try{return await t(barcodeDetectorPolyfill.BarcodeDetectorPolyfill)}catch{}try{for(let e of this._polyfillScrs)await new Promise((t,r)=>{let a=document.createElement("script");a.src=e,a.addEventListener("load",()=>t()),a.addEventListener("error",()=>r()),document.head.appendChild(a)});return await t(barcodeDetectorPolyfill.BarcodeDetectorPolyfill)}catch{throw Error("Could not load the barcode detector polyfill")}}async _isReady(){await new Promise((t,e)=>{this._error&&e(),this._ready?t():(this._readyCallbacks.push(t),this._errorCallbacks.push(e))})}async getSupportedFormats(){return await this._isReady(),this._supportedFormats}async start(){if(await this._isReady(),this._running)throw Error("The scanner is already running");this._running=!0;try{this._videoElement.srcObject=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1}),await this._videoElement.play()}catch{throw this._running=!1,Error("Could not start the camera")}this._readingInterval=window.setInterval(async()=>{let t=await this._barcodeDetector.detect(this._videoElement);t.length&&this._videoElement.dispatchEvent(new CustomEvent("codeDetected",{detail:t}))},1e3/this._frameRate)}async stop(){if(await this._isReady(),!this._running)throw Error("The scanner is not running");this._readingInterval&&window.clearInterval(this._readingInterval),this._videoElement.srcObject.getTracks().forEach(t=>t.stop()),this._running=!1}}